{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %}

    <style>
        .list-group-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transition: background-color 0.2s ease-in-out;
        }

        a {
            color: #ddd;
        }

        .form-check-input:checked {
            background-color: rgba(32, 201, 151, 0.7);
            border-color: rgba(32, 201, 151, 0.9);
        }

        .form-check-input:focus {
            border-color: rgba(32, 201, 151, 0.7);
            box-shadow: 0 0 0 .25rem rgba(32, 201, 151, 0.25);
        }

        .form-check-input:focus {
            border-color: rgba(255, 255, 255, 0.1);
            outline: 0;
            box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.1);
            background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba(0,0,0,0.25)'/></svg>");
        }
    </style>

    <!-- List of Flashcard Sets -->
    <div class="list-group" data-bs-theme="dark">
        {% for flashcard_set in flashcard_sets %}
            <div class="list-group-item d-flex align-items-center justify-content-between position-relative">

                <!-- Check if the flashcard set has at least one flashcard -->
                {% if flashcard_set.flashcard_set.exists %}
                    <a href="{% url 'flashcard-detail' flashcard_set.flashcard_set.first.id %}"
                       class="stretched-link text-decoration-none">
                {% else %}
                    <a href="" class="stretched-link text-decoration-none disabled">
                {% endif %}

                <div>
                    <h5 class="mb-1">{{ flashcard_set.title }}</h5>
                    <p class="mb-1">{{ flashcard_set.description }}</p>
                    <small class="text-muted">Created by: {{ flashcard_set.created_by.username }}
                        | {{ flashcard_set.created_at|date:"M d, Y" }}</small>
                </div>
                </a>

                <!-- Buttons -->
                <div class="d-flex align-items-center gap-2 z-1">
                    <button class="btn btn-outline-secondary btn-sm delete-flashcard-set"
                            data-flashcard-set-id="{{ flashcard_set.id }}">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm edit-flashcard-set"
                            data-flashcard-set-id="{{ flashcard_set.id }}">
                        <i class="bi bi-gear"></i>
                    </button>
                    <a href="#" class="btn btn-primary btn-sm add-flashcard-btn"
                       data-flashcard-set-id="{{ flashcard_set.id }}">Add Flashcards</a>
                </div>
            </div>
        {% empty %}
            <div class="list-group-item">
                <p class="mb-0">No flashcard sets available.</p>
            </div>
        {% endfor %}
    </div>
    </br>
    <button type="button" class="btn btn-success add-flashcard-set">
        Create Set
    </button>


    <!-- Modal for Editing Flashcard Set -->
    <div class="modal fade" id="editFlashcardSetModal" tabindex="-1" aria-labelledby="editFlashcardSetModalLabel"
         aria-hidden="true" data-bs-theme="dark">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-light" id="editFlashcardSetModalLabel">Edit Flashcard Set</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Form for Editing Flashcard Set -->
                    <form id="editFlashcardSetForm" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="editTitle" class="form-label text-light">Title</label>
                            <input type="text" class="form-control" id="editTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label text-light">Description</label>
                            <textarea class="form-control" id="editDescription" name="description" rows="3"
                                      required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" form="editFlashcardSetForm" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Adding Flashcard Set -->
    <div class="modal fade" id="addFlashcardSetModal" tabindex="-1" aria-labelledby="addFlashcardSetModalLabel"
         aria-hidden="true" data-bs-theme="dark">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-light" id="addFlashcardSetModalLabel">Add Flashcard Set</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addFlashcardSetForm" method="post" action="{% url 'add-flashcard-set' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="addTitle" class="form-label text-light">Title</label>
                            <input type="text" class="form-control" id="addTitle" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="addDescription" class="form-label text-light">Description</label>
                            <textarea class="form-control" id="addDescription" name="description" rows="3"
                                      required></textarea>
                        </div>

                        <!-- AI Generation Toggle -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center justify-content-between p-3 rounded-3"
                                 style="background: rgba(32, 201, 151, 0.1); border: 1px solid rgba(32, 201, 151, 0.3);">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-robot fs-4 me-3" style="color: #20c997;"></i>
                                    <div>
                                        <h6 class="mb-0 text-light">AI Flashcard Generator</h6>
                                        <small class="text-muted">Let AI help you!</small>
                                    </div>
                                </div>
                                <div class="form-check form-switch m-0">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                           id="aiToggle" name="generate_with_ai" style="width: 3em; height: 1.5em;">
                                </div>
                            </div>
                        </div>

                        <!-- AI Generation Fields -->
                        <div id="aiFields" style="display: none;">
                            <div class="mb-3">
                                <label for="topicInput" class="form-label text-light">Topic</label>
                                <input type="text" class="form-control" id="topicInput" name="topic"
                                       placeholder="e.g., SQL, C++, ...">
                            </div>
                            <div class="mb-3">
                                <label for="numFlashcardsInput" class="form-label text-light">Number of
                                    Flashcards</label>
                                <select class="form-select" id="numFlashcardsInput" name="num_flashcards">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" form="addFlashcardSetForm" class="btn btn-primary">Save Set</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Flashcard Modal -->
    <div class="modal fade" id="addFlashcardModal" tabindex="-1" aria-labelledby="addFlashcardModalLabel"
         aria-hidden="true" data-bs-theme="dark">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-light" id="addFlashcardModalLabel">Add Flashcard</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Form for Adding Flashcard -->
                    <form id="addFlashcardForm" method="post" action="">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="flashcardFront" class="form-label text-light">Front</label>
                            <input type="text" class="form-control" id="flashcardFront" name="front" required>
                        </div>
                        <div class="mb-3">
                            <label for="flashcardBack" class="form-label text-light">Back</label>
                            <input type="text" class="form-control" id="flashcardBack" name="back" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" form="addFlashcardForm" class="btn btn-primary">Save Flashcard</button>
                </div>
            </div>
        </div>
    </div>



    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("JavaScript Loaded");

            // Edit Flashcard Set Modal
            const gearButtons = document.querySelectorAll(".edit-flashcard-set");
            gearButtons.forEach(button => {
                button.addEventListener("click", function (event) {
                    event.preventDefault();
                    console.log("Edit button clicked");

                    const listItem = button.closest(".list-group-item");
                    const title = listItem.querySelector("h5").innerText;
                    const description = listItem.querySelector("p").innerText;
                    const flashcardSetId = button.getAttribute("data-flashcard-set-id");

                    document.getElementById("editTitle").value = title;
                    document.getElementById("editDescription").value = description;
                    document.getElementById("editFlashcardSetForm").action = `/flashcards/edit-flashcard-set/${flashcardSetId}/`;

                    const modal = new bootstrap.Modal(document.getElementById("editFlashcardSetModal"));
                    modal.show();
                });
            });

            // Add Flashcard Set Modal
            const addButton = document.querySelectorAll(".add-flashcard-set");
            addButton.forEach(button => {
                button.addEventListener("click", function (event) {
                    event.preventDefault();
                    console.log("Add button clicked");

                    const modal = new bootstrap.Modal(document.getElementById("addFlashcardSetModal"));
                    modal.show();
                });
            });


            // Open Add Flashcard Modal
            document.querySelectorAll(".add-flashcard-btn").forEach(button => {
                button.addEventListener("click", function (event) {
                    event.preventDefault();
                    console.log("Add Flashcard button clicked");

                    const flashcardSetId = button.getAttribute("data-flashcard-set-id");
                    document.getElementById("addFlashcardForm").action = `/flashcards/add-flashcard/${flashcardSetId}/`;

                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById("addFlashcardModal"));
                    modal.show();
                });
            });

            // Handle Form Submission via AJAX
            // AJAX faciliates several additions of flashcards
            document.getElementById("addFlashcardForm").addEventListener("submit", function (event) {
                event.preventDefault();  // Prevent default form submission
                console.log("Submitting flashcard form via AJAX");

                const form = this;
                const formData = new FormData(form);
                const actionUrl = form.action;

                fetch(actionUrl, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"  // Mark request as AJAX
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log("Flashcard added successfully!");

                            // Clear form fields for next input
                            form.reset();
                        } else {
                            console.error("Error adding flashcard:", data.error);
                        }
                    })
                    .catch(error => {
                        console.error("AJAX error:", error);
                    });
            });


            // Handle Flashcard Set Deletion
            const deleteButtons = document.querySelectorAll("button.delete-flashcard-set");
            deleteButtons.forEach(button => {
                button.addEventListener("click", function (event) {
                    event.preventDefault();
                    console.log("Delete button clicked");

                    const flashcardSetId = button.getAttribute("data-flashcard-set-id");

                    if (!confirm("Are you sure you want to delete this flashcard set and all flashcards within?")) {
                        return;  // Stop execution if user cancels
                    }

                    fetch(`/flashcards/delete-flashcard-set/${flashcardSetId}/`, {
                        method: "POST",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "X-CSRFToken": "{{ csrf_token }}"  // Pass CSRF token
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;  // Redirect user
                            } else {
                                console.error("No redirect URL received.");
                            }
                        })
                        .catch(error => console.error("Error deleting flashcard set:", error));
                });
            });

            // Toggle AI fields visibility
            const aiToggle = document.getElementById("aiToggle");
            const aiFields = document.getElementById("aiFields");

            if (aiToggle && aiFields) {
                aiToggle.addEventListener("change", function () {
                    aiFields.style.display = this.checked ? "block" : "none";
                    // Make topic required when AI is enabled
                    document.getElementById("topicInput").required = this.checked;
                });
            }

            // Modify the form submission to handle AI generation
            document.getElementById("addFlashcardSetForm")?.addEventListener("submit", function (e) {
                const aiEnabled = document.getElementById("aiToggle").checked;
                const topicInput = document.getElementById("topicInput");

                if (aiEnabled && !topicInput.value.trim()) {
                    e.preventDefault();
                    alert("Please enter a topic for AI set generation");
                    topicInput.focus();
                }
            });
        });
    </script>

{% endblock %}